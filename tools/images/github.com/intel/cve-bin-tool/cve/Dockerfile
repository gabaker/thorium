ARG IMAGE="ubuntu:22.04"
FROM $IMAGE

WORKDIR /app

RUN apt update && \
    apt install -y python3 python3-pip git file cabextract p7zip-full tar unzip rpm2cpio cpio build-essential binutils coreutils xterm jq && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*

# install from source
RUN git clone https://github.com/intel/cve-bin-tool.git
RUN pip install -e cve-bin-tool
RUN rm -rf /app/cve-bin-tool/.git
RUN rm -rf /app/cve-bin-tool/test

ADD wrapper.bash /app/.
RUN chmod +x /app/wrapper.bash

# download database
RUN cve-bin-tool -l info --update now || true
RUN mv /root/.cache/cve-bin-tool /app/cve-db-cache

# cancel external checks for sqlite that break sqlite scanning
# Issue: https://github.com/intel/cve-bin-tool/issues/4359
RUN sed -i 's/version_map \= \[\]/return \[\]/g' /app/cve-bin-tool/cve_bin_tool/checkers/sqlite.py

ENTRYPOINT ["bash", "/app/wrapper.bash"]